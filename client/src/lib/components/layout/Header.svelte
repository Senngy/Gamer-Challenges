<script>
  import { authStore, getAuth, isAuthenticated, clearAuth } from "$lib/store/authStore.svelte";
  import { getUserById } from "$lib/services/user.service";
  import Btn from "$lib/components/me/Btn.svelte";
  import { goto } from "$app/navigation";
  import { logout } from "$lib/services/auth.service.js";
  import { onMount } from "svelte";
  import { searchGames } from "$lib/services/game.service.js";
  let userInfo = $state({});
  let userInfoJSON = null;
  let userAvatar = null;
  let searchQuery = $state('');
  let searchResults = $state([]);

  onMount(async () => {
      try {
        userInfoJSON = localStorage.getItem("user");
        userInfo = JSON.parse(userInfoJSON);
        //console.log("userInfo", userInfo);
        const user = await getUserById(userInfo.id);
        // console.log("Utilisateur r√©cup√©r√© :", user);
        userAvatar = user.avatar;
        // console.log("Avatar r√©cup√©r√© :", userAvatar);
      } catch (error) {
        console.error("Erreur lors de la r√©cup√©ration de l'avatar :", error);
      }
  });


  $effect(() => { // 
    getAuth(); //
  });

  $effect(async () => {
     onSearch()
  });
  const onSearch = async () => {
      if (searchQuery.trim() === '') { // Si la requ√™te de recherche est vide, on vide les r√©sultats  
        searchResults = []; // On vide les r√©sultats de la recherche
        return;
      } 
      try {
        const results = await searchGames(searchQuery); 
        console.log('header search results : ', results)
        searchResults = results
        console.log('header search searchResults : ', searchResults)
        console.log("results[0].title",results[0].title )
        console.log("searchResults[0].title",searchResults[0].title )

      } catch (error) {
        console.error("Erreur lors de la recherche :", error);
        searchResults = [];
      }
    };
 
 async function cleanLogout() { // Fonction de d√©connexion
    // Logique de d√©connexion ici
    try {
      await logout(); // Appel de la fonction de d√©connexion
      clearAuth(); // Nettoyage du store d'authentification
      // Destruction du token d'authentification dans le back 
      console.log('D√©connexion r√©ussie');  
      alert("D√©connexion !");
   
    } catch (error) {
      console.error('Erreur lors de la d√©connexion :', error);
    }
    // Nettoyer le localStorage
    // Mettre √† jour le store d'authentification
    
  }
  function redirect(url) { // Redirige vers une autre page
    goto(url);
    window.location.reload();  // force le reload complet apr√®s la redirection SPA
  }

</script>

<header class="header" aria-label="En-t√™te du site Gamer Challenge">
  <!-- Logo du site -->
   <div class="header__logo" aria-label="Logo Gamer Challenge">GC</div>
   {#if isAuthenticated()}
          <p>Utilisateur : {userInfo.pseudo}</p>
   {/if}

  <!-- Barre de recherche -->
  <div class="header__search-bar" aria-label="Barre de recherche">
    <form on:submit|preventDefault={onSearch}>
    <label for="search" class="visually-hidden">Rechercher un jeu</label>
    <input
      type="search"
      id="search"
      name="search"
      bind:value={searchQuery}
      placeholder="Rechercher votre jeu... üîç"
      aria-label="Rechercher un jeu"
    />
    </form>
  </div>
  {#if searchResults.length > 0}
   <ul class="search-results">
    {#each searchResults as game}
     <li class="result-game" >
      <button type="button" class="btn-result" on:click={() => redirect(`/games/${game.id}`)}>{game.title}</button>
     </li>
    {/each}
   </ul>
  {:else if searchQuery.trim() !== ""}
    <p class="no-result">Aucun r√©sultat trouv√©</p>
  {/if}   

  <!-- Bouton menu burger -->
  <button
    class="burger"
    id="burger"
    aria-label="Ouvrir le menu"
    aria-controls="mobileMenu"
    aria-expanded="false"
  >
    &#9776;
  </button>
  <!-- Menu de navigation mobile -->
  <nav class="mobile-menu" id="mobileMenu" aria-label="Menu mobile">
    <button id="closeMenu" class="mobile-menu__close">√ó</button>
    <ul>
      <li><a href="/" class="mobile-link" sveltekit:prefetch>Accueil</a></li>
      <li>
        <a href="/games" class="mobile-link" sveltekit:prefetch>Catalogue</a>
      </li>
      <li>
        <a href="/about" class="mobile-link" sveltekit:prefetch>√Ä propos</a>
      </li>
      {#if isAuthenticated()}
      <li>
        <a href="/me" class="mobile-link" sveltekit:prefetch>Mon compte</a>
      </li>
      <li class="button">
      <Btn class="btn logout" on:click={() => {cleanLogout(); redirect('/');}}>Se d√©connecter</Btn>
      </li>
      {:else}
      <li>
        <a href="/auth/signup" class="mobile-link" sveltekit:prefetch>Inscription</a>
      </li>
      <li>
        <a href="/auth/login" class="mobile-link" sveltekit:prefetch>Connexion</a>
      </li>
      {/if}
    </ul>
  </nav>
</header>
<style>
  .button {
    display: flex;
    justify-content: center;
    margin: 1rem auto;
  }
</style>